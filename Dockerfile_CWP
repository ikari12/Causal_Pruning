# =============================================================================
# Dockerfile for Causal Intervention-Based Transformer Compression Framework
# =============================================================================
# This Dockerfile sets up a complete environment for running comprehensive
# causal pruning validation with JMTEB and MTEB datasets.
#
# Usage:
#   docker build -t causal-pruning .
#   docker run -it --gpus all -v $(pwd)/results:/app/results causal-pruning
#
# For CPU-only execution:
#   docker run -it -v $(pwd)/results:/app/results causal-pruning

FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

# =============================================================================
# Metadata
# =============================================================================
LABEL maintainer="Research Team"
LABEL description="Causal Intervention-Based Transformer Compression Framework"
LABEL version="1.0"

# =============================================================================
# Environment Variables
# =============================================================================
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Set working directory
WORKDIR /app

# =============================================================================
# System Dependencies Installation
# =============================================================================
RUN apt-get update && apt-get install -y \
    # Python and pip
    python3.10 \
    python3.10-dev \
    python3-pip \
    python3.10-venv \
    \
    # System utilities
    curl \
    wget \
    git \
    unzip \
    sudo \
    \
    # Build essentials
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    \
    # Japanese text processing dependencies
    mecab \
    libmecab-dev \
    mecab-ipadic-utf8 \
    \
    # Additional utilities
    htop \
    nano \
    vim \
    tree \
    \
    # Graphics and display (for matplotlib)
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# Python Environment Setup
# =============================================================================
# Ensure python3 points to python3.10
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1

# Upgrade pip
RUN python3 -m pip install --upgrade pip setuptools wheel

# =============================================================================
# Python Dependencies Installation
# =============================================================================
# Install Japanese text processing libraries
RUN pip install fugashi unidic-lite

# Install core ML libraries
RUN pip install torch --index-url https://download.pytorch.org/whl/cu121
RUN pip install transformer-lens einops

# Install dataset and transformer libraries
RUN pip install datasets==3.6.0

# Install additional required libraries
RUN pip install \
    torch==2.8.0 \
    datasets==3.6.0 \
    transformers==4.55.2 \
    accelerate==1.10.0 \
    safetensors==0.6.2 \
    tokenizers==0.21.4 \
    huggingface-hub==0.34.4 \
    fugashi==1.5.1 \
    unidic-lite==1.0.8 \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    scipy \
    scikit-learn \
    joblib==1.3.2 \    
    tabulate \
    tqdm

RUN pip install \
    japanize_matplotlib \
    adjustText \
    umap-learn \
    mteb[ja]

# =============================================================================
# Copy Application Files
# =============================================================================
# Copy Python scripts
COPY *.py /app/

# Copy shell scripts
COPY *.sh /app/

# Copy configuration files
COPY *.json /app/

# Copy documentation
COPY *.md /app/

# =============================================================================
# File Permissions
# =============================================================================
# Make shell scripts executable
RUN chmod +x /app/*.sh

# Make Python scripts executable
RUN chmod +x /app/*.py

# =============================================================================
# Environment Validation
# =============================================================================
# Verify Python installation
RUN python3 --version

# Verify pip installation
RUN pip --version

# Test critical imports
RUN python3 -c "import torch; print(f'PyTorch: {torch.__version__}')"
RUN python3 -c "import transformers; print(f'Transformers: {transformers.__version__}')"
RUN python3 -c "import datasets; print(f'Datasets: {datasets.__version__}')"
RUN python3 -c "import numpy; print('NumPy: Available')"
RUN python3 -c "import pandas; print('Pandas: Available')"
RUN python3 -c "import matplotlib; print('Matplotlib: Available')"

# Test Japanese processing (optional)
RUN python3 -c "import pkgutil; print('Fugashi: Available' if pkgutil.find_loader('fugashi') else 'Fugashi: Not available')"

# =============================================================================
# Create Results Directory
# =============================================================================
RUN mkdir -p /app/results
RUN mkdir -p /app/logs

# =============================================================================
# User Setup (Optional Security Enhancement)
# =============================================================================
# Create non-root user for security
RUN useradd -m -s /bin/bash researcher
RUN chown -R researcher:researcher /app
USER researcher

# =============================================================================
# Health Check
# =============================================================================
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD python3 -c "import torch, transformers, datasets; print('Health check passed')" || exit 1

# =============================================================================
# Default Execution
# =============================================================================
# Set default command to run the causal pruning execution script
CMD ["python3", "casual_sae_encode.py"]
#CMD ["python3", "casual_wanda_pruning.py"]
#CMD ["python3", "casual_wanda_pruning.py"]
#CMD ["python3", "casual_wanda_scoring.py"]
#CMD ["python3", "casual_active_pruning.py"]
#CMD ["python3", "casual_active_scoring.py"]
#CMD ["python3", "casual_neuron_scoring.py"]
#CMD ["python3", "casual_neuron_pruning.py"]
#CMD ["python3", "casual_neuron_analysis.py"]
#CMD ["python3", "casual_pruning_execution.py", "--mode", "demo"]
#CMD ["python3", "casual_pruning_execution.py", "--mode", "demo", "--clear-cache"]

# =============================================================================
# Usage Instructions (Comments)
# =============================================================================
# Build the image:
#   docker build -t causal-pruning .
#
# Run demo mode (default):
#   docker run -it --rm -v $(pwd)/results:/app/results causal-pruning
#
# Run with GPU support:
#   docker run -it --rm --gpus all -v $(pwd)/results:/app/results causal-pruning
#
# Run standard mode:
#   docker run -it --rm -v $(pwd)/results:/app/results causal-pruning \
#     bash /app/causal_pruning_execution.sh --mode standard --models 3 --datasets 10
#
# Run full mode:
#   docker run -it --rm -v $(pwd)/results:/app/results causal-pruning \
#     bash /app/causal_pruning_execution.sh --mode full
#
# Interactive mode for debugging:
#   docker run -it --rm -v $(pwd)/results:/app/results causal-pruning bash
#
# Custom configuration:
#   docker run -it --rm -v $(pwd)/config.json:/app/custom_config.json \
#     -v $(pwd)/results:/app/results causal-pruning \
#     python3 /app/causal_pruning_execution.py --mode custom --config /app/custom_config.json
#
# Skip dependency installation (if already cached):
#   docker run -it --rm -v $(pwd)/results:/app/results causal-pruning \
#     bash /app/causal_pruning_execution.sh --mode demo --skip-install
#
# View help:
#   docker run -it --rm causal-pruning \
#     bash /app/causal_pruning_execution.sh --help
#
# Generate configuration template:
#   docker run -it --rm -v $(pwd):/app/output causal-pruning \
#     python3 /app/causal_pruning_execution.py --template /app/output/config_template.json


